#!/usr/bin/env bash
# Installs mcp-stdio-toolbox via uv tool

set -euo pipefail

# Skip during Docker build to avoid disk space issues
if [ -f /.dockerenv ] || [ -n "${DOCKER_BUILD:-}" ]; then
  echo "🐳 Skipping mcp-stdio-toolbox installation during Docker build"
  echo "💡 Can be installed later with:"
  echo "  uv tool install mcp-stdio-toolbox"
  exit 0
fi

# ── Ensure ~/.local/bin is in PATH (for uv-installed tools) ───────────────
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$HOME/.local/bin:$PATH"
fi
# ──────────────────────────────────────────────────────────────────────────

# ── Load Nix environment; ensure ~/.nix-profile/bin is in PATH ──────────────
if [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi
# ─────────────────────────────────────────────────────────────

# safety-check: uv must already be on the PATH
command -v uv >/dev/null || { echo "❌ uv is not installed"; exit 1; }

echo "🔧 Installing mcp-stdio-toolbox..."

# install mcp-stdio-toolbox into uv's global toolchain
uv tool install \
  --force \
  mcp-stdio-toolbox

echo "✅ mcp-stdio-toolbox installed successfully"
echo "💡 Usage: Run MCP servers with stdio transport using mcp-stdio-toolbox"